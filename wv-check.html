<!doctype html>
<meta charset="utf-8">
<title>Widevine Level Check (webOS)</title>
<body style="font:16px system-ui;margin:2rem;line-height:1.6">
  <pre id="out">Checking Widevine...</pre>
  <div id="messages" style="margin-top:2rem"></div>
  <script>
  function addMessage(text) {
    const messagesDiv = document.getElementById('messages');
    const messageElement = document.createElement('pre');
    messageElement.textContent = text;
    messageElement.style.cssText = 'margin:0.5rem 0;padding:0.5rem;background:#f0f0f0;border-left:4px solid #007acc';
    messagesDiv.appendChild(messageElement);
  }

  async function check_wv(outputElement) {
    addMessage('Starting DRM capability check...');
    addMessage('Browser: ' + navigator.userAgent);
    
    // Check if EME is available at all
    if (!navigator.requestMediaKeySystemAccess) {
      const errorMsg = 'EME (Encrypted Media Extensions) not supported';
      outputElement.textContent = errorMsg;
      addMessage('✗ ' + errorMsg);
      addMessage('✗ This browser does not support DRM content');
      addMessage('--- Test Complete ---');
      return;
    }
    
    addMessage('✓ EME API is available');
    
    // Check Widevine support
    const widevineOptions = [{
      initDataTypes: ['cenc'],
      videoCapabilities: [
        { contentType: 'video/mp4; codecs="avc1.42E01E"' },
        { contentType: 'video/mp4; codecs="avc1.640028"', robustness: 'HW_SECURE_ALL' }
      ]
    }];
    
    addMessage('Testing Widevine support...');
    
    try {
      const access = await navigator.requestMediaKeySystemAccess('com.widevine.alpha', widevineOptions);
      const cfg = access.getConfiguration();
      const hasL1 = (cfg.videoCapabilities || []).some(c => (c.robustness||'') === 'HW_SECURE_ALL');
      
      const result = 'Widevine Level: ' + (hasL1 ? 'L1' : 'L3');
      outputElement.textContent = result;
      
      addMessage('✓ Widevine is supported!');
      addMessage('✓ ' + result);
      addMessage('✓ Configuration: ' + JSON.stringify(cfg, null, 2));
      
    } catch (widevineError) {
      addMessage('✗ Widevine not supported: ' + widevineError.name);
      
      // Check FairPlay (Safari's DRM)
      addMessage('Testing FairPlay support (Safari DRM)...');
      
      const fairplayOptions = [{
        initDataTypes: ['skd'],
        videoCapabilities: [{ contentType: 'video/mp4' }]
      }];
      
      try {
        const fairplayAccess = await navigator.requestMediaKeySystemAccess('com.apple.fps', fairplayOptions);
        const fairplayCfg = fairplayAccess.getConfiguration();
        
        outputElement.textContent = 'FairPlay DRM supported (Safari/Apple devices)';
        addMessage('✓ FairPlay DRM is supported');
        addMessage('✓ This is normal for Safari - it uses FairPlay instead of Widevine');
        addMessage('✓ Configuration: ' + JSON.stringify(fairplayCfg, null, 2));
        
      } catch (fairplayError) {
        const errorMsg = 'No DRM support detected';
        outputElement.textContent = errorMsg;
        addMessage('✗ FairPlay also not supported: ' + fairplayError.name);
        addMessage('✗ ' + errorMsg);
        addMessage('✗ Widevine error: ' + widevineError.toString());
        addMessage('✗ FairPlay error: ' + fairplayError.toString());
      }
    }
    
    // Add system information
    addMessage('--- Test Complete ---');
    addMessage('Platform: ' + navigator.platform);
    addMessage('Timestamp: ' + new Date().toISOString());
    
    // Force a visible update
    setTimeout(() => {
      addMessage('=== FINAL STATUS ===');
      addMessage(outputElement.textContent);
    }, 100);
  }

  window.onload = () => {
    addMessage('Page loaded, initializing Widevine test...');
    check_wv(document.getElementById('out'));
  };
  </script>
</body>